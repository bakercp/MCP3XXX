language: c
sudo: false
cache:
  directories:
    - ~/arduino_ide
    - ~/.arduino15/packages/
before_install:
  - source <(curl -SLs https://raw.githubusercontent.com/adafruit/travis-ci-arduino/master/install.sh)
install:
  - arduino --install-library "ArduinoUnit"
script:
  - build_main_platforms
notifications:
  email:
    on_success: change
    on_failure: change

jobs:
  include:
    - stage: Deploy Documentation
      script: 
        # Install a more recent version of Doxygen.
        - git clone --depth=1 --branch Release_1_8_15 https://github.com/doxygen/doxygen.git; cd doxygen; mkdir build; cd build; cmake -G "Unix Makefiles" ..; make -s && sudo make install; cd ../..
        # Copy all markdown docs to the docs folder and switch to the docs directory.
        - cd docs/
        # Remove docs/ prefix from all .md files for linking.
        #- sed -i'.bak' -e 's|docs/||g' *.md 
        # Fix any links to the Github pages.
        - sed -i'.bak' -e 's|../../..|https://github.com/'"$TRAVIS_REPO_SLUG"'|g' *.md && rm *.bak;
        # Generate the documentation.
        - doxygen Doxyfile 
        # Github pages will discard files beginning w/ underscores without this.
        - touch html/.nojekyll 
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GITHUB_TOKEN  # Set in the settings page of your repository, as a secure variable
        keep_history: false
        local_dir: docs/html
        on:
          branch: develop
